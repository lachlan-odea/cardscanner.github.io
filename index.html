<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card Scanner & Organizer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the video feed and scan box */
        #scanner-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            aspect-ratio: 4/3; /* Standard card ratio */
            background: #1f2937; /* Dark background */
            border-radius: 1.5rem;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Ensures video fills the container */
            transform: scaleX(-1); /* Flips the video horizontally (like a selfie camera) */
        }
        
        /* Hidden canvas for image capture */
        #canvas {
            display: none;
        }

        /* Style for extracted text block to preserve formatting */
        pre {
            white-space: pre-wrap;
            word-break: break-word;
            padding: 0.5rem;
            margin-top: 0.5rem;
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8 font-sans">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-6 text-center">
            ðŸ“„ Card Scanner & List
        </h1>
        <p class="text-center text-gray-600 mb-8">
            Use your camera to scan a card, extract text via OCR (Tesseract.js), and save it locally.
        </p>

        <!-- Scanner Section -->
        <section class="mb-12 flex flex-col items-center p-6 bg-white rounded-2xl shadow-xl">
            <!-- Video Feed Container -->
            <div id="scanner-container">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas"></canvas>
            </div>

            <!-- Controls and Loading State -->
            <div class="mt-8 flex space-x-4">
                <button id="scan-button" 
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition shadow-lg disabled:bg-indigo-400 disabled:cursor-wait flex items-center justify-center min-w-[150px]">
                    <svg id="scan-icon" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                    <span>Scan Card</span>
                </button>
                <button id="clear-button" 
                        class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-xl transition shadow-lg disabled:opacity-50">
                    Clear List
                </button>
            </div>
            
            <p id="status-message" class="mt-4 text-sm text-gray-500 font-medium h-6"></p>

        </section>

        <!-- Scanned Cards List Section -->
        <section class="p-6 bg-white rounded-2xl shadow-xl">
            <h2 class="text-2xl font-semibold text-gray-900 mb-4 border-b pb-2">Scanned Cards History</h2>
            <ul id="card-list" class="space-y-6">
                <!-- Cards will be dynamically inserted here -->
            </ul>
        </section>
    </div>

    <!-- Tesseract.js CDN (Crucial for OCR) -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

    <script>
        // --- Global Variables ---
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const scanButton = document.getElementById('scan-button');
        const clearButton = document.getElementById('clear-button');
        const cardList = document.getElementById('card-list');
        const statusMessage = document.getElementById('status-message');
        
        let worker;

        // --- Core Functions ---

        async function setupCamera() {
            try {
                // Request camera access
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } // Prefer back camera on mobile
                });
                video.srcObject = stream;
                statusMessage.textContent = "Camera access granted. Waiting for OCR engine...";
                video.addEventListener('loadedmetadata', () => {
                    video.play();
                });
            } catch (err) {
                console.error("Error accessing the camera:", err);
                statusMessage.textContent = "Error: Could not access camera. Ensure HTTPS and permissions are granted.";
                scanButton.disabled = true;
            }
        }

        async function setupOcrWorker() {
            try {
                // Initial setup UI
                scanButton.disabled = true;
                scanButton.innerHTML = '<svg class="animate-spin w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 0013 4a8 8 0 00-6.162 1.954l-4.225 4.225m15.356 2A8.001 8.001 0 0111 20a8 8 0 016.162-1.954l4.225-4.225"></path></svg> <span>Loading OCR...</span>';
                statusMessage.textContent = "Loading Tesseract.js OCR engine (first run may take time)...";
                
                // Create the worker and load the English language pack
                worker = await Tesseract.createWorker('eng');
                
                // Final setup UI
                scanButton.innerHTML = '<svg id="scan-icon" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg> <span>Scan Card</span>';
                scanButton.disabled = false;
                statusMessage.textContent = "Scanner ready! Position a card in the view and click 'Scan Card'.";

            } catch (error) {
                console.error("Tesseract Worker setup failed:", error);
                statusMessage.textContent = "FATAL ERROR: OCR Engine failed to load.";
                scanButton.disabled = true;
            }
        }
        
        function createCardElement(card) {
            const listItem = document.createElement('li');
            listItem.className = "p-4 border border-gray-200 rounded-lg flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 bg-gray-50 hover:shadow-md transition";
            
            listItem.innerHTML = `
                <div class="flex-shrink-0 w-full sm:w-1/3 md:w-1/4">
                    <img src="${card.capturedImage}" 
                         class="rounded-lg w-full h-auto object-cover border border-gray-300" 
                         alt="Scanned Card Image"/> 
                </div>
                <div class="flex-grow">
                    <p class="text-xs text-gray-500 mb-1">Scanned at: ${new Date(card.id).toLocaleString()}</p>
                    <strong class="text-lg text-indigo-700">Extracted Text:</strong>
                    <pre class="text-sm text-gray-800">${card.extractedText || "No text extracted."}</pre>
                </div>
            `;
            return listItem;
        }

        function addCardToList(card) {
            // 1. Update the display (DOM)
            const listItem = createCardElement(card);
            cardList.prepend(listItem); // Show the newest at the top
            
            // 2. Update LocalStorage
            const existingCards = JSON.parse(localStorage.getItem('scannedCards') || '[]');
            existingCards.push(card);
            localStorage.setItem('scannedCards', JSON.stringify(existingCards));
            
            statusMessage.textContent = `Successfully scanned card and extracted ${card.extractedText.length} characters!`;
        }

        function loadCardsFromStorage() {
            const existingCards = JSON.parse(localStorage.getItem('scannedCards') || '[]');
            if (existingCards.length === 0) {
                cardList.innerHTML = '<p class="text-gray-500 text-center py-4">No cards scanned yet. Start scanning!</p>';
                return;
            }

            // Clear placeholder and load items
            cardList.innerHTML = ''; 
            existingCards.reverse().forEach(card => {
                const listItem = createCardElement(card);
                cardList.appendChild(listItem);
            });
        }
        
        function clearAllCards() {
            localStorage.removeItem('scannedCards');
            loadCardsFromStorage(); // Reloads the empty state
            statusMessage.textContent = "All scanned cards have been cleared.";
        }


        // --- Event Listeners ---

        scanButton.addEventListener('click', async () => {
            if (!worker || scanButton.disabled) {
                // If button is disabled, OCR is loading or an error occurred
                return;
            }

            // 1. Prepare UI for scanning
            scanButton.disabled = true;
            scanButton.innerHTML = '<svg class="animate-spin w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 0013 4a8 8 0 00-6.162 1.954l-4.225 4.225m15.356 2A8.001 8.001 0 0111 20a8 8 0 016.162-1.954l4.225-4.225"></path></svg> <span>Scanning...</span>';
            statusMessage.textContent = "Capturing image and processing text via OCR...";
            
            try {
                // 2. Capture the frame
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageToOcr = canvas.toDataURL('image/png');
                
                // 3. Perform OCR
                const { data: { text } } = await worker.recognize(imageToOcr);
                
                // 4. Create and save the card object
                const cardData = {
                    id: Date.now(),
                    capturedImage: imageToOcr,
                    extractedText: text.trim() || "OCR found no discernible text."
                };

                addCardToList(cardData);

            } catch (error) {
                console.error("OCR or Capture Failed:", error);
                // Use a custom modal or message box instead of alert()
                document.getElementById('status-message').textContent = "OCR failed to process image. Check console for details.";
            }

            // 5. Restore UI
            scanButton.innerHTML = '<svg id="scan-icon" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg> <span>Scan Card</span>';
            scanButton.disabled = false;
        });

        clearButton.addEventListener('click', clearAllCards);

        // --- Initialization ---

        window.onload = function() {
            setupCamera();
            setupOcrWorker();
            loadCardsFromStorage();
        }

    </script>
</body>
</html>
